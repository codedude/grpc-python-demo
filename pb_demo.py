import sys
import json
import marshal
import gzip
import logging

# The google API has some features like helpers, builders, reflection...
from google.protobuf import json_format

# We can import our data structures generated by Protocol Buffer
from pb.sub.sub_demo_pb2 import (
    ReportResponse,
    ActionType,
    WarningMsgType,
    Measure,
    WarningMsg,
    RequestReport,
    RequestAction,
    RequestSetConfig,
    ApiResponse,
)
import helpers

logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.DEBUG)


def main():
    # Create a report with fake data
    report = helpers.create_report(1000)
    # Convert data to binary
    pb_bin_out = report.SerializeToString()
    # Compare size of data to raw json and regular marshalling
    json_pretty_out = json_format.MessageToJson(report)
    json_python = json.loads(json_pretty_out)
    json_mini_out = json.dumps(json_python, indent=None, separators=(",", ":"))
    json_gzip_out = gzip.compress(json_mini_out.encode("utf-8"))
    json_marshal_out = marshal.dumps(json_python)
    print(f"JSON str prettyfy:\t{len(json_pretty_out)} bytes")
    print(f"JSON str minify\t\t{len(json_mini_out)} bytes")
    print(f"JSON Marshal:\t\t{len(json_marshal_out)} bytes")
    print(f"JSON minify gzip:\t{len(json_gzip_out)} bytes")
    print(f"Protocol Buffer:\t{len(pb_bin_out)} bytes")
    print(f"Protocol Buffer gzip:\t{len(gzip.compress(pb_bin_out))} bytes")
    # Convert binary back to json
    new_report = ReportResponse()
    new_report.ParseFromString(pb_bin_out)
    # We get the same data
    assert new_report == report
    return 0


if __name__ == "__main__":
    sys.exit(main())
